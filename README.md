# AstrBot 记忆连接插件 (Memora Connect)

一个模仿人类记忆方式的记忆插件，能够智能记录、回忆和关联对话中的重要信息。

## 🆕 新增功能：智能数据库迁移

### 自动数据库结构适配
当插件更新导致数据库结构变化时，系统会自动检测并执行智能迁移：

- **零配置自动检测**：无需手动配置，自动识别数据库版本差异
- **多维度智能转换**：结合LLM、embedding相似度、规则引擎进行数据转换
- **自动备份保护**：迁移前自动创建完整备份，支持一键回滚
- **错误恢复机制**：迁移失败时自动回滚，确保数据安全

### 迁移流程
1. **检测阶段**：启动时自动检测数据库结构版本
2. **备份阶段**：创建带时间戳的完整数据库备份
3. **分析阶段**：使用LLM分析字段语义，建立智能映射
4. **转换阶段**：多策略并行转换，确保数据完整性
5. **验证阶段**：验证转换结果，失败自动回滚

### 支持的转换类型
- **字段类型转换**：如TEXT到VARCHAR，INTEGER到REAL
- **字段重命名**：基于语义分析的智能字段映射
- **新增字段**：自动填充默认值或基于内容推导
- **删除字段**：安全移除，数据归档到备份
- **表结构变更**：支持新增表、外键关系等复杂变更

## 核心功能

### 记忆形成
- 自动从对话中提取主题和关键词
- 使用LLM生成自然语言记忆
- 构建概念-记忆-关联的知识图谱

### 智能回忆
- **多模式回忆**：支持简单、LLM、embedding三种回忆模式
- **联想回忆**：基于知识图谱的关联记忆激活
- **语义搜索**：基于嵌入向量的相似度匹配
- **上下文注入**：自动将相关记忆注入对话上下文

### 记忆管理
- **遗忘机制**：模拟人类遗忘，降低不活跃记忆强度
- **记忆整理**：自动合并相似记忆，保持知识库整洁
- **强度调节**：根据访问频率调整记忆强度

## 使用方法

### 基本指令
- `/记忆` - 显示系统状态
- `/记忆 回忆 [关键词]` - 回忆相关记忆
- `/记忆 状态` - 查看系统统计

### LLM工具
- `create_memory(content, topic)` - 主动创建记忆
- `recall_memory(keyword)` - 主动回忆记忆

## 安装与配置

1. 将插件放入 `AstrBot/data/plugins/` 目录
2. 重启AstrBot
3. 在WebUI中启用插件
4. 根据需要调整配置（可选）

## 技术架构

### 数据模型
- **Concept**：概念节点，代表主题或关键词
- **Memory**：记忆条目，存储具体对话内容
- **Connection**：概念间的关联关系

### 核心算法
- **激活扩散**：基于神经网络的记忆激活算法
- **语义嵌入**：使用LLM的嵌入向量进行语义匹配
- **知识图谱**：构建概念间的关联网络

## 版本更新

### v0.2.0
- ✅ 新增智能数据库迁移系统
- ✅ 支持多维度数据转换
- ✅ 自动备份和回滚机制
- ✅ LLM驱动的字段映射
- ✅ 嵌入向量相似度转换

### v0.1.0
- 基础记忆功能
- 知识图谱构建
- 多模式回忆系统

## 注意事项

- 数据库迁移过程完全自动化，无需用户干预
- 迁移前会自动创建备份，可在 `data/memora_connect/backups/` 查看
- 如遇迁移失败，系统会自动回滚，不影响原有数据
- 建议定期备份重要记忆数据

## 故障排除

### 迁移失败
1. 检查 `logs/` 目录中的错误日志
2. 查看 `backups/` 中的备份文件
3. 手动恢复：将备份文件重命名为 `memory.db`

### 性能优化
- 调整 `max_memories_per_topic` 限制单主题记忆数量
- 设置合适的 `forget_threshold_days` 控制遗忘速度
- 根据需求选择回忆模式（simple/llm/embedding）

## 开发说明

插件采用模块化设计，核心组件：
- `MemorySystem`：记忆管理核心
- `MemoryGraph`：知识图谱数据结构
- `DatabaseMigration`：智能迁移系统

## 许可证
MIT License
