# 数据库迁移诊断计划

## 🚨 问题分析

**用户反馈错误**: `状态加载异常: no such column: group_id`

**问题根源**: 现有的数据库文件还是旧的结构，没有 `group_id` 字段，但代码已经尝试访问这个字段。

## 🔍 诊断步骤

### 1. 检查当前数据库状态
需要检查现有数据库文件的结构，确认是否缺少 `group_id` 字段。

**检查内容**:
- 数据库文件是否存在
- 数据库表结构（特别是 `memories` 表）
- 是否有 `group_id` 字段
- 现有数据情况

### 2. 分析数据库迁移系统
从代码分析来看，数据库迁移系统应该是工作的，但可能存在问题：

**可能的问题**:
1. **迁移失败**: 数据库迁移在执行过程中失败了，但没有正确回滚
2. **迁移未触发**: 迁移系统没有被正确调用
3. **权限问题**: 数据库文件权限导致迁移失败
4. **现有数据冲突**: 现有数据结构与迁移逻辑冲突

### 3. 检查迁移调用链
需要确认数据库迁移是否被正确调用：

**调用链**:
1. `MemorySystem.initialize()` → `SmartDatabaseMigration.run_smart_migration()`
2. 迁移系统分析现有结构
3. 迁移系统生成目标结构
4. 迁移系统执行差异检测
5. 迁移系统执行数据迁移

## 🛠️ 解决方案

### 方案A: 手动执行数据库迁移
创建一个独立的脚本来手动执行数据库迁移，添加 `group_id` 字段。

**步骤**:
1. 备份现有数据库
2. 执行 ALTER TABLE 添加 `group_id` 字段
3. 创建相关索引
4. 验证迁移结果

### 方案B: 修复迁移系统
如果迁移系统有问题，需要修复迁移逻辑。

**可能的问题点**:
1. 字段映射错误
2. 数据类型不匹配
3. 索引创建失败
4. 事务处理问题

### 方案C: 重建数据库
如果迁移太复杂，可以考虑重建数据库结构。

**步骤**:
1. 备份现有数据
2. 删除旧数据库
3. 创建新数据库结构
4. 导入备份数据

## 📋 具体执行计划

### 第一步: 诊断当前状态
1. 检查数据库文件是否存在
2. 检查 `memories` 表结构
3. 确认是否缺少 `group_id` 字段

### 第二步: 手动迁移
如果确认缺少 `group_id` 字段，执行以下SQL：

```sql
-- 添加 group_id 字段
ALTER TABLE memories ADD COLUMN group_id TEXT DEFAULT '';

-- 创建群聊隔离索引
CREATE INDEX IF NOT EXISTS idx_memories_group_id ON memories(group_id);
CREATE INDEX IF NOT EXISTS idx_memories_concept_group ON memories(concept_id, group_id);
CREATE INDEX IF NOT EXISTS idx_memories_created_group ON memories(created_at, group_id);
```

### 第三步: 验证迁移结果
1. 检查 `group_id` 字段是否存在
2. 检查索引是否创建成功
3. 测试数据读写操作

### 第四步: 测试群聊隔离功能
1. 运行验证脚本
2. 测试群聊记忆隔离
3. 确认错误已解决

## 🎯 预期结果

**成功标准**:
- 数据库包含 `group_id` 字段
- 群聊隔离索引存在
- 不再出现 `no such column: group_id` 错误
- 群聊记忆隔离功能正常工作

## 🔄 回滚计划

如果迁移失败，需要能够回滚到原始状态：

1. 恢复备份数据库文件
2. 记录失败原因
3. 调整迁移策略
4. 重新尝试迁移

## 📊 风险评估

**低风险操作**:
- 添加字段（有默认值）
- 创建索引

**中等风险操作**:
- 数据迁移
- 结构修改

**高风险操作**:
- 删除数据
- 重建数据库

## 📝 注意事项

1. **备份优先**: 在任何修改前必须备份
2. **逐步验证**: 每个步骤都要验证结果
3. **错误处理**: 准备好错误处理方案
4. **测试环境**: 先在测试环境验证
5. **文档记录**: 记录所有操作步骤

## 🚀 执行顺序

1. 诊断当前数据库状态
2. 创建数据库备份
3. 手动执行迁移SQL
4. 验证迁移结果
5. 测试群聊隔离功能
6. 更新相关文档